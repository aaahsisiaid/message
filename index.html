<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>モダンLINE風チャット（QR読取対応・自動ログイン）</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  body {
    margin: 0;
    font-family: "Helvetica Neue", Arial, sans-serif;
    background: #e5ddd5;
    display: flex;
    flex-direction: column;
    height: 100vh;
  }
  header {
    background: #075e54;
    color: #fff;
    padding: 15px;
    text-align: center;
    font-size: 1.2rem;
  }
  #auth, #main {
    flex: 1;
    display: none;
    flex-direction: column;
    align-items: center;
    padding: 15px;
    overflow-y: auto;
  }
  #auth { display: flex; }
  input, button {
    font-size: 1rem;
    padding: 8px;
    margin: 4px 0;
    width: 100%;
    max-width: 300px;
    box-sizing: border-box;
    border-radius: 5px;
    border: 1px solid #ccc;
  }
  button.primary {
    background: #128c7e;
    color: white;
    border: none;
    cursor: pointer;
  }
  button.primary:hover {
    background: #0e755f;
  }
  #info {
    width: 100%;
    max-width: 500px;
    margin-bottom:15px;
  }
  #my-qr {
    margin: 10px auto;
  }
  #friend-section, #qr-reader, #notifications {
    width: 100%;
    max-width: 500px;
    background: #fff;
    padding: 15px;
    border-radius: 10px;
    margin-bottom: 15px;
  }
  #friend-list button {
    width: 100%;
    margin: 5px 0;
    text-align: left;
    background: #fff;
    border: 1px solid #ddd;
  }
  #chat {
    flex:1;
    width:100%;
    max-width:500px;
    display:flex;
    flex-direction:column;
  }
  #messages {
    flex:1;
    background: #fff;
    padding:10px;
    border-radius:10px;
    overflow-y:auto;
    margin-bottom:10px;
  }
  .message {
    max-width:70%;
    margin:5px;
    padding:10px;
    border-radius:10px;
    word-break:break-word;
    position: relative;
  }
  .my-message {
    align-self:flex-end;
    background:#dcf8c6;
    border-bottom-right-radius:0;
  }
  .other-message {
    align-self:flex-start;
    background:#fff;
    border-bottom-left-radius:0;
  }
  .msg-meta {
    font-size: 0.7rem;
    color: gray;
    margin-top: 3px;
  }
  #input-area {
    display:flex;
  }
  #input-area input {
    flex:1;
    margin-right:5px;
    border-radius:20px;
    border:1px solid #ccc;
    padding:10px 15px;
    font-size: 1rem;
  }
  #input-area button {
    width:80px;
    border-radius:20px;
    background:#128c7e;
    color:#fff;
    border:none;
    font-weight:bold;
    cursor:pointer;
    transition: background-color 0.3s;
  }
  #input-area button:hover {
    background:#0e755f;
  }
  #notifications {
    max-height: 150px;
    overflow-y: auto;
  }
  .notification {
    border-bottom: 1px solid #ddd;
    padding: 8px 5px;
  }
  .notification button {
    margin-left: 5px;
    font-size: 0.8rem;
    padding: 3px 7px;
  }
</style>
</head>
<body>
<header>モダンLINE風チャット</header>

<div id="auth">
  <input id="user" placeholder="ユーザー名" />
  <input id="pass" type="password" placeholder="パスワード" />
  <button class="primary" onclick="register()">新規登録</button>
  <button class="primary" onclick="login()">ログイン</button>
  <p id="auth-msg" style="color:red;"></p>
</div>

<div id="main">
  <div id="info">
    <span>ようこそ、<strong id="uname"></strong> さん<br />あなたのID：<strong id="uid"></strong></span>
    <div id="my-qr"></div>
    <button class="primary" onclick="logout()" style="margin-top:10px;">ログアウト</button>
  </div>

  <div id="notifications">
    <h4>通知</h4>
    <div id="notification-list"></div>
  </div>

  <div id="friend-section">
    <input id="friend-id" placeholder="相手のUID" />
    <button class="primary" onclick="sendFriendRequest()">友達追加リクエスト送信</button>
    <button class="primary" onclick="startQR()">QR読み取り</button>
    <div id="qr-reader" style="display:none;"></div>
    <h4>友達リスト</h4>
    <div id="friend-list"></div>
  </div>

  <div id="chat">
    <div id="messages"></div>
    <div id="input-area">
      <input id="msg-text" placeholder="メッセージ" />
      <button id="send-btn">送信</button>
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://unpkg.com/html5-qrcode"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyAEdcU79-YWhTVyuaRIKL8Y7uZ3Yujw0Fs",
  authDomain: "message-95d75.firebaseapp.com",
  projectId: "message-95d75",
  storageBucket: "message-95d75.appspot.com",
  messagingSenderId: "348991178331",
  appId: "1:348991178331:web:a504a5885f5df5491ba17e",
  measurementId: "G-LGM9GQK2HK"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let currentUID = "", currentName = "", currentThread = "";
let approvedFriends = [];
let friendRequests = [];

function genUID(name) {
  const r = Math.random().toString(36).substr(2, 6);
  return `uid_${name}_${r}`;
}

async function register() {
  const u = document.getElementById("user").value.trim(),
    p = document.getElementById("pass").value;
  if (!u || !p) {
    showAuthMsg("全て入力してください");
    return;
  }
  // 重複チェック
  const exists = await db.collection("users").where("username", "==", u).get();
  if (!exists.empty) {
    showAuthMsg("ユーザー名は既に使用されています");
    return;
  }
  const uid = genUID(u);
  await db.collection("users").add({ username: u, password: p, uid, friends: [], pendingRequests: [] });
  showAuthMsg("登録完了。ログインしてください。");
}

function showAuthMsg(msg) {
  document.getElementById("auth-msg").innerText = msg;
}

async function login() {
  const u = document.getElementById("user").value.trim(),
    p = document.getElementById("pass").value;
  if (!u || !p) {
    showAuthMsg("全て入力してください");
    return false;
  }
  const snap = await db
    .collection("users")
    .where("username", "==", u)
    .where("password", "==", p)
    .get();
  if (snap.empty) {
    showAuthMsg("認証失敗");
    return false;
  }
  const d = snap.docs[0].data();
  currentName = d.username;
  currentUID = d.uid;
  document.getElementById("auth").style.display = "none";
  document.getElementById("main").style.display = "flex";
  document.getElementById("uname").innerText = currentName;
  document.getElementById("uid").innerText = currentUID;
  new QRCode(document.getElementById("my-qr"), { text: currentUID, width: 128, height: 128 });
  localStorage.setItem("chatUser", JSON.stringify({ username: currentName, uid: currentUID, password: p }));
  approvedFriends = [];
  friendRequests = [];
  loadFriends();
  setupFriendRequestsListener();
  return true;
}

function logout() {
  localStorage.removeItem("chatUser");
  location.reload();
}

async function loadFriends() {
  const list = document.getElementById("friend-list");
  list.innerHTML = "";
  const s = await db.collection("users").where("uid", "==", currentUID).get();
  if (s.empty) return;
  approvedFriends = s.docs[0].data().friends || [];
  friendRequests = s.docs[0].data().pendingRequests || [];

  // 友達だけリスト表示
  for (const fid of approvedFriends) {
    const fSnap = await db.collection("users").where("uid", "==", fid).get();
    if (fSnap.empty) continue;
    const fn = fSnap.docs[0].data().username;
    const btn = document.createElement("button");
    btn.innerText = fn;
    btn.onclick = () => openChat(fid, fn);
    list.append(btn);
  }
  showNotifications();
}

function getThread(u1, u2) {
  return [u1, u2].sort().join("__");
}

function openChat(fid, fname) {
  currentThread = getThread(currentUID, fid);
  document.getElementById("messages").innerHTML = "";
  db.collection("messages")
    .doc(currentThread)
    .collection("messages")
    .orderBy("timestamp")
    .onSnapshot((ss) => {
      const mdiv = document.getElementById("messages");
      mdiv.innerHTML = "";
      ss.forEach((d) => {
        const m = d.data();
        const el = document.createElement("div");
        el.className = "message " + (m.name === currentName ? "my-message" : "other-message");
        el.innerHTML = `${m.name}: ${m.text} <div class="msg-meta">${m.timestamp ? m.timestamp.toDate().toLocaleString() : ""} ${m.read ? "✔✔" : ""}</div>`;
        mdiv.append(el);

        // 既読処理
        if (m.name !== currentName && !m.read) {
          d.ref.update({ read: true });
        }
      });
      mdiv.scrollTop = mdiv.scrollHeight;
    });
}

document.getElementById("send-btn").onclick = () => {
  const t = document.getElementById("msg-text").value.trim();
  if (!t || !currentThread) return;
  db.collection("messages")
    .doc(currentThread)
    .collection("messages")
    .add({ name: currentName, text: t, timestamp: firebase.firestore.FieldValue.serverTimestamp(), read: false });
  document.getElementById("msg-text").value = "";
};

function startQR() {
  document.getElementById("qr-reader").style.display = "block";
  new Html5Qrcode("qr-reader").start(
    { facingMode: "environment" },
    { fps: 10, qrbox: 250 },
    (qr) => {
      document.getElementById("friend-id").value = qr;
      alert("読み取り完了！");
      stopQR();
    }
  );
}
function stopQR() {
  Html5Qrcode.getCameras().then(() => {
    const qrReader = document.getElementById("qr-reader");
    qrReader.style.display = "none";
  });
}

// --- 通知機能 ---

async function sendFriendRequest() {
  const fid = document.getElementById("friend-id").value.trim();
  if (!fid) return alert("相手のUIDを入力してください");
  if (fid === currentUID) return alert("自分自身は追加できません");

  // 相手のユーザードキュメント
  const snap = await db.collection("users").where("uid", "==", fid).get();
  if (snap.empty) return alert("相手が存在しません");

  const doc = snap.docs[0];
  const data = doc.data();

  // すでに友達か確認
  if (data.friends && data.friends.includes(currentUID)) {
    return alert("既に友達です");
  }
  // すでにリクエスト送信済みか
  if (data.pendingRequests && data.pendingRequests.includes(currentUID)) {
    return alert("既にリクエスト送信済みです");
  }

  // 相手のpendingRequestsにcurrentUIDを追加
  let pr = data.pendingRequests || [];
  pr.push(currentUID);
  await db.collection("users").doc(doc.id).update({ pendingRequests: pr });

  alert("友達リクエストを送信しました");
}

function setupFriendRequestsListener() {
  // 自分のpendingRequestsを監視し通知表示
  db.collection("users")
    .where("uid", "==", currentUID)
    .onSnapshot((snap) => {
      if (snap.empty) return;
      const data = snap.docs[0].data();
      friendRequests = data.pendingRequests || [];
      approvedFriends = data.friends || [];
      showNotifications();
      loadFriends();
    });
}

function showNotifications() {
  const container = document.getElementById("notification-list");
  container.innerHTML = "";

  friendRequests.forEach(async (fid) => {
    // 相手の名前取得
    const snap = await db.collection("users").where("uid", "==", fid).get();
    if (snap.empty) return;
    const name = snap.docs[0].data().username;

    const div = document.createElement("div");
    div.className = "notification";
    div.innerHTML = `${name} さんから友達追加リクエストが届いています。`;

    const btnAccept = document.createElement("button");
    btnAccept.innerText = "承認";
    btnAccept.onclick = () => acceptFriend(fid);

    const btnReject = document.createElement("button");
    btnReject.innerText = "拒否";
    btnReject.onclick = () => rejectFriend(fid);

    div.appendChild(btnAccept);
    div.appendChild(btnReject);
    container.appendChild(div);
  });
}

async function acceptFriend(fid) {
  // 自分のドキュメント取得
  const s1 = await db.collection("users").where("uid", "==", currentUID).get();
  if (s1.empty) return;
  const doc1 = s1.docs[0];
  const d1 = doc1.data();

  // 相手のドキュメント取得
  const s2 = await db.collection("users").where("uid", "==", fid).get();
  if (s2.empty) return;
  const doc2 = s2.docs[0];
  const d2 = doc2.data();

  let f1 = d1.friends || [];
  if (!f1.includes(fid)) f1.push(fid);

  let f2 = d2.friends || [];
  if (!f2.includes(currentUID)) f2.push(currentUID);

  let pr = d1.pendingRequests || [];
  pr = pr.filter((x) => x !== fid);

  await db.collection("users").doc(doc1.id).update({ friends: f1, pendingRequests: pr });
  await db.collection("users").doc(doc2.id).update({ friends: f2 });

  approvedFriends = f1;
  friendRequests = pr;

  showNotifications();
  loadFriends();
  alert("友達追加が承認されました。チャットが可能です。");
}

async function rejectFriend(fid) {
  const s1 = await db.collection("users").where("uid", "==", currentUID).get();
  if (s1.empty) return;
  const doc1 = s1.docs[0];
  const d1 = doc1.data();

  let pr = d1.pendingRequests || [];
  pr = pr.filter((x) => x !== fid);

  await db.collection("users").doc(doc1.id).update({ pendingRequests: pr });
  friendRequests = pr;
  showNotifications();
}

// --- 自動ログイン ---

window.onload = async () => {
  const saved = localStorage.getItem("chatUser");
  if (saved) {
    try {
      const obj = JSON.parse(saved);
      if (obj && obj.username && obj.uid && obj.password) {
        document.getElementById("user").value = obj.username;
        document.getElementById("pass").value = obj.password;
        const success = await login();
        if (!success) {
          localStorage.removeItem("chatUser");
        }
      }
    } catch (e) {
      console.error(e);
    }
  }
};
</script>
</body>
</html>
