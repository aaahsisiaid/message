<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>モダンLINE風チャット（QR・通知・既読対応）</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  body {
    margin: 0;
    font-family: "Helvetica Neue", Arial, sans-serif;
    background: #e5ddd5;
    display: flex;
    flex-direction: column;
    height: 100vh;
  }
  header {
    background: #075e54;
    color: #fff;
    padding: 15px;
    text-align: center;
    font-size: 1.2rem;
    position: relative;
  }
  #logout-btn {
    position: absolute;
    right: 15px;
    top: 15px;
    background: #128c7e;
    border: none;
    color: white;
    padding: 5px 10px;
    border-radius: 10px;
    cursor: pointer;
  }
  #auth, #main {
    flex: 1;
    display: none;
    flex-direction: column;
    align-items: center;
    padding: 15px;
    overflow-y: auto;
  }
  #auth { display: flex; }
  input, button {
    font-size: 1rem;
    padding: 8px;
    margin: 4px 0;
    width: 100%;
    max-width: 300px;
    box-sizing: border-box;
    border-radius: 5px;
    border: 1px solid #ccc;
  }
  button.primary {
    background: #128c7e;
    color: white;
    border: none;
    cursor: pointer;
    transition: background 0.3s ease;
  }
  button.primary:hover {
    background: #0e755f;
  }
  #info {
    width: 100%;
    max-width: 500px;
    margin-bottom: 10px;
    color: #222;
  }
  #my-qr {
    margin: 10px 0;
  }
  #friend-section, #qr-reader, #notifications {
    width: 100%;
    max-width: 500px;
    background: #fff;
    padding: 15px;
    border-radius: 10px;
    margin-bottom: 15px;
    box-sizing: border-box;
  }
  #friend-list > div {
    display: flex;
    justify-content: space-between;
    margin: 5px 0;
  }
  #friend-list button.friend-name {
    flex: 1;
    background: none;
    border: none;
    text-align: left;
    padding: 5px 10px;
    font-weight: 600;
    cursor: pointer;
    color: #075e54;
  }
  #friend-list button.friend-name:hover {
    text-decoration: underline;
  }
  #friend-list button.edit-subname {
    background: #128c7e;
    color: white;
    border-radius: 5px;
    border: none;
    padding: 5px 10px;
    cursor: pointer;
  }
  #notifications {
    max-height: 120px;
    overflow-y: auto;
    font-size: 0.9rem;
  }
  #notifications div {
    padding: 8px;
    border-bottom: 1px solid #ddd;
  }
  #notifications div button {
    margin-left: 10px;
    background: #128c7e;
    border: none;
    color: white;
    padding: 4px 8px;
    border-radius: 5px;
    cursor: pointer;
  }
  #chat {
    flex: 1;
    width: 100%;
    max-width: 500px;
    display: flex;
    flex-direction: column;
    background: #fff;
    border-radius: 10px;
    box-sizing: border-box;
  }
  #messages {
    flex: 1;
    padding: 10px;
    overflow-y: auto;
    border-radius: 10px 10px 0 0;
    background: #fff;
  }
  .message {
    max-width: 70%;
    margin: 5px 0;
    padding: 10px 12px;
    border-radius: 18px;
    word-break: break-word;
    position: relative;
    font-size: 0.95rem;
    line-height: 1.2em;
    box-shadow: 0 1px 1px rgb(0 0 0 / 0.1);
  }
  .my-message {
    align-self: flex-end;
    background: #dcf8c6;
    border-bottom-right-radius: 0;
  }
  .other-message {
    align-self: flex-start;
    background: #fff;
    border-bottom-left-radius: 0;
  }
  .msg-meta {
    font-size: 0.7rem;
    color: gray;
    margin-top: 4px;
    display: flex;
    justify-content: flex-end;
    gap: 5px;
  }
  #input-area {
    display: flex;
    padding: 10px;
    background: #f0f0f0;
    border-radius: 0 0 10px 10px;
  }
  #input-area input {
    flex: 1;
    margin-right: 5px;
    border-radius: 20px;
    border: 1px solid #ccc;
    padding: 10px 15px;
    font-size: 1rem;
    outline: none;
  }
  #input-area input:focus {
    border-color: #128c7e;
  }
  #input-area button {
    width: 80px;
    border-radius: 20px;
    background: #128c7e;
    border: none;
    color: white;
    font-weight: bold;
    cursor: pointer;
    transition: background 0.3s ease;
  }
  #input-area button:hover {
    background: #0e755f;
  }
  #qr-reader {
    display: none;
  }
</style>
</head>
<body>

<header>
  モダンLINE風チャット
  <button id="logout-btn" style="display:none;">ログアウト</button>
</header>

<div id="auth">
  <input id="user" placeholder="ユーザー名" autocomplete="username" />
  <input id="pass" type="password" placeholder="パスワード" autocomplete="current-password" />
  <button class="primary" onclick="register()">新規登録</button>
  <button class="primary" onclick="login()">ログイン</button>
  <p id="auth-msg" style="color:red;"></p>
</div>

<div id="main">
  <div id="info">
    <span>ようこそ、<strong id="uname"></strong> さん<br>あなたのID：<strong id="uid"></strong></span>
    <div id="my-qr"></div>
  </div>

  <div id="friend-section">
    <input id="friend-id" placeholder="相手のUIDを入力" />
    <button class="primary" onclick="sendFriendRequest()">友達追加リクエスト送信</button>
    <button class="primary" onclick="startQR()">QR読み取り</button>
    <div id="qr-reader"></div>
    <h4>友達リスト</h4>
    <div id="friend-list"></div>
  </div>

  <div id="notifications">
    <h4>通知</h4>
    <div id="notification-list"></div>
  </div>

  <div id="chat">
    <div id="messages"></div>
    <div id="input-area">
      <input id="msg-text" placeholder="メッセージを入力..." />
      <button id="send-btn">送信</button>
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://unpkg.com/html5-qrcode"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyAEdcU79-YWhTVyuaRIKL8Y7uZ3Yujw0Fs",
  authDomain: "message-95d75.firebaseapp.com",
  projectId: "message-95d75",
  storageBucket: "message-95d75.appspot.com",
  messagingSenderId: "348991178331",
  appId: "1:348991178331:web:a504a5885f5df5491ba17e",
  measurementId: "G-LGM9GQK2HK"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let currentUID = "", currentName = "", currentUserDocId = "", currentThread = "";
let approvedFriends = [], friendRequests = [], subNames = {};

function genUID(name) {
  const r = Math.random().toString(36).substr(2, 6);
  return `uid_${name}_${r}`;
}

async function register() {
  const u = document.getElementById("user").value.trim();
  const p = document.getElementById("pass").value;
  if (!u || !p) {
    showAuthMsg("全て入力してください");
    return;
  }
  // 同じユーザー名が存在しないかチェック
  const existing = await db.collection("users").where("username", "==", u).get();
  if (!existing.empty) {
    showAuthMsg("そのユーザー名は既に使われています");
    return;
  }
  const uid = genUID(u);
  await db.collection("users").add({
    username: u,
    password: p,
    uid,
    friends: [],
    pendingRequests: [],
    subNames: {}
  });
  showAuthMsg("登録完了。ログインしてください。");
}

function showAuthMsg(msg) {
  document.getElementById("auth-msg").innerText = msg;
}

async function login() {
  const u = document.getElementById("user").value.trim();
  const p = document.getElementById("pass").value;
  if (!u || !p) {
    showAuthMsg("全て入力してください");
    return;
  }
  const snap = await db
    .collection("users")
    .where("username", "==", u)
    .where("password", "==", p)
    .get();
  if (snap.empty) {
    showAuthMsg("認証失敗");
    return;
  }
  const doc = snap.docs[0];
  currentUserDocId = doc.id;
  const d = doc.data();
  currentName = d.username;
  currentUID = d.uid;
  subNames = d.subNames || {};
  document.getElementById("auth").style.display = "none";
  document.getElementById("main").style.display = "flex";
  document.getElementById("logout-btn").style.display = "block";
  document.getElementById("uname").innerText = currentName;
  document.getElementById("uid").innerText = currentUID;
  new QRCode(document.getElementById("my-qr"), { text: currentUID, width: 128, height: 128 });
  localStorage.setItem("chatUser", JSON.stringify({ username: currentName, uid: currentUID, password: p, userDocId: currentUserDocId }));
  await loadFriends();
  setupFriendRequestsListener();
  clearAuthMsg();
}

function clearAuthMsg() {
  document.getElementById("auth-msg").innerText = "";
}

async function loadFriends() {
  const list = document.getElementById("friend-list");
  list.innerHTML = "";
  const doc = await db.collection("users").doc(currentUserDocId).get();
  if (!doc.exists) return;
  const data = doc.data();
  approvedFriends = data.friends || [];
  friendRequests = data.pendingRequests || [];
  subNames = data.subNames || {};

  for (const fid of approvedFriends) {
    const fSnap = await db.collection("users").where("uid", "==", fid).get();
    if (fSnap.empty) continue;
    const fn = fSnap.docs[0].data().username;
    const displayName = subNames[fid] || fn;

    const container = document.createElement("div");
    container.style.display = "flex";
    container.style.justifyContent = "space-between";
    container.style.alignItems = "center";

    const btn = document.createElement("button");
    btn.className = "friend-name";
    btn.innerText = displayName;
    btn.onclick = () => openChat(fid, displayName);

    const editBtn = document.createElement("button");
    editBtn.className = "edit-subname";
    editBtn.innerText = "✏️";
    editBtn.onclick = () => editSubName(fid, fn);

    container.appendChild(btn);
    container.appendChild(editBtn);
    list.appendChild(container);
  }
  showNotifications();
}

function editSubName(fid, originalName) {
  const newName = prompt(`「${originalName}」のサブネームを入力してください。空欄で削除。`, subNames[fid] || "");
  if (newName === null) return; // キャンセル
  if (newName.trim() === "") {
    delete subNames[fid];
  } else {
    subNames[fid] = newName.trim();
  }
  db.collection("users").doc(currentUserDocId).update({ subNames });
  loadFriends();
}

// 通知関係
async function setupFriendRequestsListener() {
  db.collection("users").doc(currentUserDocId).onSnapshot((doc) => {
    if (!doc.exists) return;
    const data = doc.data();
    friendRequests = data.pendingRequests || [];
    approvedFriends = data.friends || [];
    subNames = data.subNames || {};
    showNotifications();
    loadFriends();
  });
}

function showNotifications() {
  const notifContainer = document.getElementById("notification-list");
  notifContainer.innerHTML = "";

  friendRequests.forEach((fid) => {
    const notifDiv = document.createElement("div");
    notifDiv.innerText = `ユーザーID ${fid} から友達追加リクエストが届いています。`;
    const acceptBtn = document.createElement("button");
    acceptBtn.innerText = "承認";
    acceptBtn.onclick = () => acceptFriend(fid);
    notifDiv.appendChild(acceptBtn);
    notifContainer.appendChild(notifDiv);
  });

  if (friendRequests.length === 0) {
    notifContainer.innerText = "通知はありません。";
  }
}

// 友達追加リクエスト送信
async function sendFriendRequest() {
  const fid = document.getElementById("friend-id").value.trim();
  if (!fid) {
    alert("相手のUIDを入力してください。");
    return;
  }
  if (fid === currentUID) {
    alert("自分自身を追加できません。");
    return;
  }
  // 既に友達かどうかチェック
  if (approvedFriends.includes(fid)) {
    alert("既に友達です。");
    return;
  }
  // 相手のユーザー情報取得
  const s = await db.collection("users").where("uid", "==", fid).get();
  if (s.empty) {
    alert("そのUIDのユーザーは存在しません。");
    return;
  }
  const doc = s.docs[0];
  const d = doc.data();
  const pending = d.pendingRequests || [];
  if (pending.includes(currentUID)) {
    alert("すでに友達追加リクエストを送っています。");
    return;
  }
  // 自分が既に相手の友達なら不要
  const friendsOfOther = d.friends || [];
  if (friendsOfOther.includes(currentUID)) {
    alert("相手はすでにあなたの友達です。");
    return;
  }
  // 相手のpendingRequestsに自分のUID追加
  pending.push(currentUID);
  await db.collection("users").doc(doc.id).update({ pendingRequests: pending });
  alert("友達追加リクエストを送信しました。");
  document.getElementById("friend-id").value = "";
}

// 友達追加承認（双方向に追加）
async function acceptFriend(fid) {
  if (!fid) return;
  const meDoc = await db.collection("users").doc(currentUserDocId).get();
  if (!meDoc.exists) return;
  const meData = meDoc.data();

  const s2 = await db.collection("users").where("uid", "==", fid).get();
  if (s2.empty) return;
  const friendDoc = s2.docs[0];
  const friendData = friendDoc.data();

  // 自分のfriendsにfid追加（重複除去）
  let myFriends = meData.friends || [];
  if (!myFriends.includes(fid)) myFriends.push(fid);

  // 自分のpendingRequestsからfid除去
  let myPending = meData.pendingRequests || [];
  myPending = myPending.filter((x) => x !== fid);

  // 相手のfriendsにcurrentUID追加（重複除去）
  let friendFriends = friendData.friends || [];
  if (!friendFriends.includes(currentUID)) friendFriends.push(currentUID);

  await db.collection("users").doc(currentUserDocId).update({
    friends: myFriends,
    pendingRequests: myPending,
  });
  await db.collection("users").doc(friendDoc.id).update({
    friends: friendFriends,
  });

  approvedFriends = myFriends;
  friendRequests = myPending;
  showNotifications();
  loadFriends();
  alert("友達追加が承認されました。チャットが可能です。");
}

// 既読管理・メッセージ送信
document.getElementById("send-btn").onclick = async () => {
  const text = document.getElementById("msg-text").value.trim();
  if (!text || !currentThread) return;
  await db
    .collection("messages")
    .doc(currentThread)
    .collection("messages")
    .add({
      name: currentName,
      text: text,
      timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      readBy: [currentUID],
    });
  document.getElementById("msg-text").value = "";
};

// チャット開く
function getThread(u1, u2) {
  return [u1, u2].sort().join("__");
}

let unsubscribeChat = null;

async function openChat(fid, fname) {
  if (!approvedFriends.includes(fid)) {
    alert("友達追加承認されていません。");
    return;
  }
  currentThread = getThread(currentUID, fid);
  document.getElementById("messages").innerHTML = "";
  if (unsubscribeChat) unsubscribeChat();

  unsubscribeChat = db
    .collection("messages")
    .doc(currentThread)
    .collection("messages")
    .orderBy("timestamp")
    .onSnapshot((ss) => {
      const mdiv = document.getElementById("messages");
      mdiv.innerHTML = "";
      ss.forEach(async (d) => {
        const m = d.data();
        const el = document.createElement("div");
        el.className = "message " + (m.name === currentName ? "my-message" : "other-message");

        // メッセージ表示テキスト
        const displayName = m.name === currentName ? currentName : fname;
        el.innerText = `${displayName}: ${m.text}`;

        // 送信日時表示
        const ts = m.timestamp ? m.timestamp.toDate() : null;
        const timeStr = ts ? ts.toLocaleString() : "送信日時不明";

        // 既読表示（✔✔は自分が送信したメッセージも相手のも表示）
        const isRead = m.readBy && m.readBy.includes(currentUID);
        const readMark = isRead ? "✔✔" : "✓";

        // メタ情報を付加
        const meta = document.createElement("div");
        meta.className = "msg-meta";
        meta.textContent = `${timeStr} ${readMark}`;
        el.appendChild(meta);

        mdiv.appendChild(el);

        // 自分が読んだことを既読に追加
        if (!isRead) {
          const msgRef = db
            .collection("messages")
            .doc(currentThread)
            .collection("messages")
            .doc(d.id);
          await msgRef.update({
            readBy: firebase.firestore.FieldValue.arrayUnion(currentUID),
          });
        }
      });
      mdiv.scrollTop = mdiv.scrollHeight;
    });
}

// QRコード読み取り開始
function startQR() {
  const qrContainer = document.getElementById("qr-reader");
  qrContainer.style.display = "block";
  const html5QrCode = new Html5Qrcode("qr-reader");
  html5QrCode
    .start(
      { facingMode: "environment" },
      { fps: 10, qrbox: 250 },
      (qr) => {
        document.getElementById("friend-id").value = qr;
        alert("読み取り完了！");
        html5QrCode.stop();
        qrContainer.style.display = "none";
      }
    )
    .catch((err) => {
      console.error("QR読み取りエラー:", err);
    });
}

// ログアウト処理
document.getElementById("logout-btn").onclick = () => {
  localStorage.removeItem("chatUser");
  currentUID = "";
  currentName = "";
  currentUserDocId = "";
  currentThread = "";
  approvedFriends = [];
  friendRequests = [];
  subNames = {};
  if (unsubscribeChat) unsubscribeChat();
  document.getElementById("main").style.display = "none";
  document.getElementById("auth").style.display = "flex";
  document.getElementById("logout-btn").style.display = "none";
  document.getElementById("user").value = "";
  document.getElementById("pass").value = "";
  document.getElementById("auth-msg").innerText = "";
  document.getElementById("messages").innerHTML = "";
  document.getElementById("friend-list").innerHTML = "";
  document.getElementById("notification-list").innerHTML = "";
  document.getElementById("my-qr").innerHTML = "";
};

// ページロード時にローカルストレージから自動ログイン
window.onload = async () => {
  const userStr = localStorage.getItem("chatUser");
  if (!userStr) {
    document.getElementById("auth").style.display = "flex";
    return;
  }
  try {
    const user = JSON.parse(userStr);
    if (!user.username || !user.uid || !user.password || !user.userDocId) {
      document.getElementById("auth").style.display = "flex";
      return;
    }
    // パスワードを使って再認証（簡易）
    const snap = await db
      .collection("users")
      .where("username", "==", user.username)
      .where("password", "==", user.password)
      .get();
    if (snap.empty) {
      localStorage.removeItem("chatUser");
      document.getElementById("auth").style.display = "flex";
      return;
    }
    const doc = snap.docs[0];
    currentUserDocId = doc.id;
    currentName = user.username;
    currentUID = user.uid;
    subNames = doc.data().subNames || {};
    document.getElementById("auth").style.display = "none";
    document.getElementById("main").style.display = "flex";
    document.getElementById("logout-btn").style.display = "block";
    document.getElementById("uname").innerText = currentName;
    document.getElementById("uid").innerText = currentUID;
    new QRCode(document.getElementById("my-qr"), { text: currentUID, width: 128, height: 128 });
    await loadFriends();
    setupFriendRequestsListener();
  } catch (e) {
    console.error("自動ログインエラー", e);
    document.getElementById("auth").style.display = "flex";
  }
};
</script>
</body>
</html>
