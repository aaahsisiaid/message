<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>モダンLINE風チャット</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      margin: 0;
      font-family: "Helvetica Neue", Arial, sans-serif;
      background: #e5ddd5;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    header {
      background: #075e54;
      color: #fff;
      padding: 15px;
      text-align: center;
      font-size: 1.2rem;
      position: relative;
      z-index: 1;
    }
    /* 通話バー */
    #call-bar {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0;
      background: #128c7e;
      color: white;
      padding: 10px 15px;
      z-index: 2000;
      font-weight: bold;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }
    #call-bar button {
      margin-left: 10px;
      border: none;
      border-radius: 5px;
      padding: 5px 10px;
      cursor: pointer;
      color: white;
      font-weight: bold;
    }
    #call-answer-btn {
      background: #25d366;
    }
    #call-hangup-btn {
      background: #f44336;
    }

    #auth, #main {
      flex: 1;
      display: none;
      flex-direction: column;
      align-items: center;
      padding: 15px;
      overflow-y: auto;
      margin-top: 50px; /* 通話バーのスペース確保 */
    }
    #auth { display: flex; }
    input, button {
      font-size: 1rem;
      padding: 8px;
      margin: 4px 0;
      width: 100%;
      max-width: 300px;
      box-sizing: border-box;
      border-radius: 5px;
      border: 1px solid #ccc;
    }
    button.primary {
      background: #128c7e;
      color: white;
      border: none;
      cursor: pointer;
    }
    button.primary:hover {
      background: #0e755f;
    }
    #info, #friend-section, #chat, #notification-box {
      width: 100%;
      max-width: 500px;
      background: #fff;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 15px;
    }
    #friend-list > div {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    #friend-list button.friend-name {
      background: #fff;
      border: 1px solid #ddd;
      width: auto;
      flex: 1;
      text-align: left;
      cursor: pointer;
      padding: 8px 10px;
      border-radius: 5px;
    }
    #friend-list button.edit-subname {
      background: #eee;
      color: #333;
      width: 40px;
      margin-left: 8px;
      font-size: 1.2em;
      line-height: 1;
      padding: 5px 0;
    }
    #messages {
      flex: 1;
      background: #fff;
      padding: 10px;
      border-radius: 10px;
      overflow-y: auto;
      margin-bottom: 10px;
      height: 300px;
    }
    .message {
      max-width: 70%;
      margin: 5px;
      padding: 10px;
      border-radius: 10px;
      word-break: break-word;
      position: relative;
    }
    .my-message {
      align-self: flex-end;
      background: #dcf8c6;
      border-bottom-right-radius: 0;
    }
    .other-message {
      align-self: flex-start;
      background: #fff;
      border-bottom-left-radius: 0;
    }
    .msg-meta {
      font-size: 0.7em;
      color: gray;
      margin-top: 4px;
    }
    #input-area {
      display: flex;
      margin-top: 10px;
    }
    #input-area input {
      flex: 1;
      margin-right: 5px;
      border-radius: 20px;
      border: 1px solid #ccc;
      padding: 10px;
    }
    #input-area button {
      width: 80px;
      border-radius: 20px;
    }
    #live-typing {
      font-size: 0.9em;
      color: #555;
      margin-bottom: 5px;
      text-align: center;
    }
    .delete-btn {
      position: absolute;
      top: 2px;
      right: 6px;
      font-size: 0.8em;
      cursor: pointer;
      color: red;
    }
    #start-call {
      margin-top: 10px;
      background: #25d366;
      border: none;
      color: white;
      border-radius: 20px;
      padding: 10px 15px;
      cursor: pointer;
      font-weight: bold;
    }
    #start-call:hover {
      background: #128c7e;
    }
  </style>
</head>
<body>
<header>モダンLINE風チャット</header>

<!-- 通話バー -->
<div id="call-bar">
  <span id="call-bar-text">文字通話リクエストがあります</span>
  <div>
    <button id="call-answer-btn">応答</button>
    <button id="call-hangup-btn">切る</button>
  </div>
</div>

<div id="auth">
  <input id="user" placeholder="ユーザー名" autocomplete="off" />
  <input id="pass" type="password" placeholder="パスワード" autocomplete="off" />
  <button class="primary" onclick="register()">新規登録</button>
  <button class="primary" onclick="login()">ログイン</button>
  <p id="auth-msg" style="color:red;"></p>
</div>

<div id="main">
  <div id="info">
    <span>ようこそ、<strong id="uname"></strong> さん<br />あなたのID：<strong id="uid"></strong></span>
    <button id="logout-btn" class="primary">ログアウト</button>
    <div id="my-qr"></div>
  </div>

  <div id="notification-box">
    <h4>通知</h4>
    <div id="notification-list"></div>
  </div>

  <div id="friend-section">
    <input id="friend-id" placeholder="相手のUID" autocomplete="off" />
    <button class="primary" onclick="addFriend()">友達追加</button>
    <button class="primary" onclick="startQR()">QR読み取り</button>
    <div id="qr-reader" style="display:none;"></div>
    <h4>友達リスト</h4>
    <div id="friend-list"></div>
  </div>

  <div id="chat">
    <button id="start-call" style="display:none;">文字通話を開始</button>
    <div id="live-typing"></div>
    <div id="messages"></div>
    <div id="input-area">
      <input id="msg-text" placeholder="メッセージ" autocomplete="off" />
      <button id="send-btn" class="primary">送信</button>
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://unpkg.com/html5-qrcode"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyAEdcU79-YWhTVyuaRIKL8Y7uZ3Yujw0Fs",
  authDomain: "message-95d75.firebaseapp.com",
  projectId: "message-95d75",
  storageBucket: "message-95d75.appspot.com",
  messagingSenderId: "348991178331",
  appId: "1:348991178331:web:a504a5885f5df5491ba17e",
  measurementId: "G-LGM9GQK2HK"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let currentUID = "", currentName = "", currentThread = "", subNames = {}, typingTimeout;
let isInCall = false;
let callPartnerUID = "";
let incomingCallFrom = ""; // 誰からの通話か

const callBar = document.getElementById("call-bar");
const callBarText = document.getElementById("call-bar-text");
const callAnswerBtn = document.getElementById("call-answer-btn");
const callHangupBtn = document.getElementById("call-hangup-btn");

// --- 以下は省略せず必要な関数だけ抜粋・調整 ---
// 自動ログインチェックや登録・ログインは省略

// 通話リクエスト監視を強化
function listenCallRequests(){
  db.collection("users").where("uid","==",currentUID).onSnapshot(snap => {
    if(snap.empty) return;
    const d = snap.docs[0].data();
    const calls = d.callRequests || [];

    if(calls.length > 0 && !isInCall && !incomingCallFrom){
      incomingCallFrom = calls[0];
      callBarText.innerText = `${incomingCallFrom} から文字通話リクエストがあります`;
      callBar.style.display = "flex";
    }

    if(d.callStatus === "ended"){
      endCallUI("相手が文字通話を切りました");
    }
  });
}

// 通話開始ボタン押した時の処理
document.getElementById("start-call").onclick = () => {
  if(!currentThread || !callPartnerUID) return alert("チャットを選択してください");
  isInCall = true;
  document.getElementById("start-call").style.display = "none";
  document.getElementById("live-typing").innerText = "文字通話中...";
  document.getElementById("msg-text").disabled = false;
  document.getElementById("send-btn").disabled = false;
  sendCallRequest(callPartnerUID);
  incomingCallFrom = "";
  callBar.style.display = "none";
}

// 通話リクエスト送信
async function sendCallRequest(toUID){
  const snap = await db.collection("users").where("uid", "==", toUID).get();
  if(snap.empty) return;
  const doc = snap.docs[0];
  const callReqs = doc.data().callRequests || [];
  if(!callReqs.includes(currentUID)){
    callReqs.push(currentUID);
    await db.collection("users").doc(doc.id).update({callRequests: callReqs, callStatus: "calling"});
  }
}

// 応答ボタン押下
callAnswerBtn.onclick = async () => {
  if(!incomingCallFrom) return;
  isInCall = true;
  callPartnerUID = incomingCallFrom;

  callBarText.innerText = `文字通話中（${incomingCallFrom}）`;
  callAnswerBtn.style.display = "none";

  document.getElementById("start-call").style.display = "none";
  document.getElementById("live-typing").innerText = "文字通話中...";
  document.getElementById("msg-text").disabled = false;
  document.getElementById("send-btn").disabled = false;

  const snap = await db.collection("users").where("uid", "==", currentUID).get();
  if(!snap.empty){
    const doc = snap.docs[0];
    const callReqs = doc.data().callRequests || [];
    const newReqs = callReqs.filter(uid => uid !== incomingCallFrom);
    await db.collection("users").doc(doc.id).update({callRequests: newReqs, callStatus: "inCall"});
  }
  incomingCallFrom = "";
};

// 切るボタン押下
callHangupBtn.onclick = async () => {
  if(!isInCall && !incomingCallFrom){
    if(incomingCallFrom){
      const snap = await db.collection("users").where("uid", "==", currentUID).get();
      if(!snap.empty){
        const doc = snap.docs[0];
        const callReqs = doc.data().callRequests || [];
        const newReqs = callReqs.filter(uid => uid !== incomingCallFrom);
        await db.collection("users").doc(doc.id).update({callRequests: newReqs, callStatus: "idle"});
      }
      incomingCallFrom = "";
    }
    callBar.style.display = "none";
    return;
  }
  if(isInCall){
    const snap = await db.collection("users").where("uid", "==", callPartnerUID).get();
    if(!snap.empty){
      const doc = snap.docs[0];
      await db.collection("users").doc(doc.id).update({callStatus: "ended"});
    }
    endCallUI("文字通話を切りました");
  }
};

// 通話終了UIリセット
function endCallUI(msg){
  isInCall = false;
  callPartnerUID = "";
  incomingCallFrom = "";
  callBar.style.display = "none";
  callAnswerBtn.style.display = "inline-block";
  document.getElementById("start-call").style.display = "inline-block";
  document.getElementById("live-typing").innerText = "";
  document.getElementById("msg-text").disabled = false;
  document.getElementById("send-btn").disabled = false;
  alert(msg);
}

// 他の関数は省略しますが、認証、友達管理、メッセージ送信受信などは
// これまで通り実装してください。

</script>
</body>
</html>
